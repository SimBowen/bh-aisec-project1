name: Publish image

on:
  workflow_dispatch:
    inputs:
      image:
        description: "The OCI image name. This must not include a tag or digest."
        type: string
        default: "docker.io/htxbowen/bh-aisec-project1-echo-server"
      digest:
        description: "The OCI image digest. The image digest of the form '<algorithm>:<digest>' (e.g. 'sha256:abcdef...')"
        type: string
        default: "sha256:79ab2c4dbee4c9f7b24e561bbbf5d1065a30f8784fdb5d5e565015edc52b20ff"  # Use the verified digest
      environment:
        type: choice
        description: Environment to use
        options: 
        - prod
        - staging

permissions: read-all

defaults:
  run:
    shell: bash

env:
  IMAGE_REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}-echo-server

jobs:
  publish:
    permissions:
      id-token: write
      packages: write
      contents: read
    uses: SimBowen/bh-aisec-organization/.github/workflows/image-publisher.yml@main
    with:
      environment: ${{ inputs.environment }}
      image: ${{ inputs.image }}
      digest: ${{ inputs.digest }}
      registry-username: htxbowen
    secrets:
      registry-password: ${{ secrets.REGISTRY_PASSWORD }}
